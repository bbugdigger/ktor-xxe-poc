# CVE-2023-45612 Security Vulnerability Report
## XML External Entity (XXE) Injection in Ktor ContentNegotiation

**Report Date:** September 26, 2025  
**Vulnerability:** CVE-2023-45612  
**Severity:** High  
**CVSS Score:** 7.5  
**Affected Versions:** Ktor < 2.3.5 with xmlutil < 0.86.2  

---

## Executive Summary

CVE-2023-45612 is an XML External Entity (XXE) vulnerability in Ktor's ContentNegotiation plugin when using XML serialization. The default configuration of ContentNegotiation with XML format was vulnerable to XXE attacks, allowing attackers to read local files, perform server-side request forgery (SSRF), and potentially achieve remote code execution.

The vulnerability exists in the xmlutil library (version 0.86.1 and earlier) used by Ktor's ContentNegotiation for XML processing. The XML parser was configured to process external entities by default, without proper security restrictions.

---

## Technical Details

### Root Cause
The vulnerability stems from the default configuration of the XML parser in xmlutil 0.86.1, which had the following dangerous settings enabled by default:

```kotlin
// Vulnerable configuration (implicit in xmlutil 0.86.1)
factory.isExpandEntityReferences = true
factory.setFeature("http://xml.org/sax/features/external-general-entities", true)
factory.setFeature("http://xml.org/sax/features/external-parameter-entities", true)
```

### Attack Vector
When an application uses Ktor's ContentNegotiation with XML support, attackers can send malicious XML payloads containing external entity references:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE UserData [
<!ELEMENT UserData ANY>
<!ELEMENT name ANY>
<!ELEMENT email ANY>
<!ENTITY xxe SYSTEM "file:///C:/Windows/System32/drivers/etc/hosts">
]>
<UserData>
    <name>&xxe;</name>
    <email>test@example.com</email>
</UserData>
```

### Impact
- **File Disclosure:** Read sensitive files from the server filesystem
- **Server-Side Request Forgery (SSRF):** Make requests to internal services
- **Denial of Service:** Consume server resources through billion laughs attacks
- **Remote Code Execution:** In some configurations with specific XML parsers

---

## Proof of Concept

### Environment Setup
- **Ktor Version:** 2.2.4 (vulnerable)
- **xmlutil Version:** 0.86.1 (vulnerable)
- **Target:** Ktor application with ContentNegotiation XML support

### Vulnerable Application Code
```kotlin
// Application.kt
fun Application.module() {
    configureSerialization()
    configureRouting()
}

// Serialization.kt
fun Application.configureSerialization() {
    install(ContentNegotiation) {
        // Vulnerable: Uses xmlutil 0.86.1 with default settings
        val xmlFormat = XML { /* default configuration */ }
        register(ContentType.Application.Xml, XmlConverter(xmlFormat))
    }
}

// Routing.kt
post("/xml") {
    val userData = call.receive<UserData>() // XXE vulnerability triggered here
    call.respondText("Received: ${userData.name}")
}
```

---

## Reproduction Steps

### Step 1: Set up Vulnerable Environment
1. Clone the vulnerable Ktor application
2. Ensure `gradle/libs.versions.toml` contains:
   ```toml
   ktor = "2.2.4"
   xmlutil = "0.86.1"
   ```
3. Build and run the application:
   ```bash
   ./gradlew build
   ./gradlew run
   ```

### Step 2: Execute the Attack
1. Use the provided POC script to test the vulnerability
2. The script sends malicious XML to the `/xml` endpoint
3. Observe file contents in the response

### Step 3: Verify Impact
- Check server logs for XML processing
- Confirm file contents are returned in the response
- Test with different target files to verify scope

---

## Developer Guidelines for XXE Prevention

### 1. Update Dependencies
**Immediate Action Required:**
```kotlin
// gradle/libs.versions.toml
ktor = "2.3.5"  // or later
xmlutil = "0.86.2"  // or later
```

### 2. Secure XML Parser Configuration
**Always disable external entity processing:**
```kotlin
fun Application.configureSerialization() {
    install(ContentNegotiation) {
        val secureXmlFormat = XML {
            xmlDeclMode = XmlDeclMode.Auto
            indent = 2
            // Security: Disable external entities
            repairNamespaces = true
        }
        register(ContentType.Application.Xml, XmlConverter(secureXmlFormat))
    }
}
```

### 3. Input Validation and Sanitization
```kotlin
post("/xml") {
    try {
        // Validate XML structure before processing
        val rawXml = call.receiveText()
        if (containsExternalEntities(rawXml)) {
            call.respond(HttpStatusCode.BadRequest, "Invalid XML: External entities not allowed")
            return@post
        }
        
        // Process validated XML
        val userData = call.receive<UserData>()
        call.respondText("Received: ${userData.name}")
    } catch (e: Exception) {
        call.respond(HttpStatusCode.BadRequest, "XML processing error")
    }
}

fun containsExternalEntities(xml: String): Boolean {
    return xml.contains("<!ENTITY") && 
           (xml.contains("SYSTEM") || xml.contains("PUBLIC"))
}
```

### 4. Use Allow-lists for XML Processing
```kotlin
// Only allow specific XML structures
@Serializable
data class UserData(
    @XmlElement val name: String,
    @XmlElement val email: String
) {
    init {
        // Validate field contents
        require(name.length <= 100) { "Name too long" }
        require(email.matches(Regex("^[^<>&]*$"))) { "Invalid email format" }
    }
}
```

### 5. Network Security Controls
```kotlin
// Restrict outbound connections from XML parser
fun configureSecureXmlParser(): DocumentBuilderFactory {
    val factory = DocumentBuilderFactory.newInstance()
    
    // Disable external entities
    factory.isExpandEntityReferences = false
    factory.setFeature("http://xml.org/sax/features/external-general-entities", false)
    factory.setFeature("http://xml.org/sax/features/external-parameter-entities", false)
    factory.setFeature("http://apache.org/xml/features/nonvalidating/load-external-dtd", false)
    
    // Additional security features
    factory.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true)
    factory.isNamespaceAware = true
    factory.isValidating = false
    
    return factory
}
```

### 6. Monitoring and Logging
```kotlin
post("/xml") {
    val startTime = System.currentTimeMillis()
    try {
        // Log XML processing attempts
        logger.info("XML processing started for ${call.request.origin.remoteHost}")
        
        val userData = call.receive<UserData>()
        
        val processingTime = System.currentTimeMillis() - startTime
        if (processingTime > 1000) {
            logger.warn("Slow XML processing detected: ${processingTime}ms")
        }
        
        call.respondText("Success")
    } catch (e: Exception) {
        logger.error("XML processing failed", e)
        call.respond(HttpStatusCode.BadRequest, "Invalid request")
    }
}
```

### 7. Content Security Policy
```kotlin
install(DefaultHeaders) {
    header("Content-Security-Policy", "default-src 'self'; script-src 'none'")
    header("X-Content-Type-Options", "nosniff")
    header("X-Frame-Options", "DENY")
}
```

---

## Security Testing Checklist

### For Developers:
- [ ] Update to Ktor 2.3.5+ and xmlutil 0.86.2+
- [ ] Disable external entity processing in XML parsers
- [ ] Implement input validation for XML content
- [ ] Add monitoring for suspicious XML processing patterns
- [ ] Test with XXE payloads in development environment
- [ ] Review all XML processing endpoints

### For Security Teams:
- [ ] Scan for vulnerable dependencies in CI/CD pipeline
- [ ] Include XXE tests in penetration testing
- [ ] Monitor for unusual file access patterns
- [ ] Implement network segmentation to limit XXE impact
- [ ] Regular security code reviews for XML processing code

---

## References

- **CVE-2023-45612:** https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-45612
- **Ktor Security Advisory:** https://github.com/ktorio/ktor/security/advisories
- **OWASP XXE Prevention:** https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing
- **xmlutil Security Update:** https://github.com/pdvrieze/xmlutil/releases

---

## Conclusion

CVE-2023-45612 represents a critical security vulnerability that affects applications using Ktor's ContentNegotiation with XML processing. The vulnerability allows attackers to read sensitive files and potentially compromise server security.

**Immediate actions required:**
1. Update to Ktor 2.3.5 or later
2. Update xmlutil to 0.86.2 or later  
3. Review and secure all XML processing code
4. Implement the security guidelines outlined above

The combination of dependency updates and secure coding practices will effectively mitigate this vulnerability and prevent similar issues in the future.
